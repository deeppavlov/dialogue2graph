
<!DOCTYPE html>


<html lang="en" data-content_root="../../../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dialog2graph.metrics.no_llm_metrics.keys2graph.metrics_semantic_jaccard &#8212; Dialog2Graph  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/css/custom.css?v=2286c558" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/dialog2graph/metrics/no_llm_metrics/keys2graph/metrics_semantic_jaccard';</script>
    <script src="../../../../../_static/scripts/pydata-sphinx-theme.js?v=a1eb5d9f"></script>
    <script src="../../../../../_static/scripts/bootstrap.js?v=7583a70d"></script>
    <script src="../../../../../_static/scripts/fontawesome.js?v=9b125980"></script>
    <link rel="canonical" href="/dialog2graph/dev/_modules/dialog2graph/metrics/no_llm_metrics/keys2graph/metrics_semantic_jaccard.html" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Dialog2Graph  documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../getting_started.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../research.html">
    Research
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../userguides.html">
    User guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../autoapi/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../development.html">
    Development
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../about_us.html">
    About us
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/deeppavlov/dialog2graph" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../getting_started.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../research.html">
    Research
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../userguides.html">
    User guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../autoapi/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../development.html">
    Development
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../about_us.html">
    About us
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/deeppavlov/dialog2graph" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../../../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../../../metrics.html" class="nav-link">dialog2graph.metrics</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">dialog2graph.metrics.no_llm_metrics.keys2graph.metrics_semantic_jaccard</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for dialog2graph.metrics.no_llm_metrics.keys2graph.metrics_semantic_jaccard</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAI</span>


<div class="viewcode-block" id="evaluate_graph_lists">
<a class="viewcode-back" href="../../../../../autoapi/dialog2graph/metrics/no_llm_metrics/keys2graph/metrics_semantic_jaccard/index.html#dialog2graph.metrics.no_llm_metrics.keys2graph.metrics_semantic_jaccard.evaluate_graph_lists">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_graph_lists</span><span class="p">(</span>
    <span class="n">original_graphs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">generated_graphs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;o1-mini&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Сравнивает пары графов (original_graphs[i], generated_graphs[i]) по Semantic-Jaccard метрике,</span>
<span class="sd">    но не через эмбеддинги, а через большую языковую модель (LLM).</span>

<span class="sd">    Модель получает пару графов, внутри промпта ей даётся задание сопоставить ноды</span>
<span class="sd">    и рёбра по смыслу. На выходе модель должна вернуть JSON с полями:</span>
<span class="sd">      {</span>
<span class="sd">        &quot;matched_nodes&quot;: [</span>
<span class="sd">          [node1_id, node2_id],</span>
<span class="sd">          ...</span>
<span class="sd">        ],</span>
<span class="sd">        &quot;matched_edges&quot;: [</span>
<span class="sd">          [src1, tgt1, src2, tgt2],</span>
<span class="sd">          ...</span>
<span class="sd">        ]</span>
<span class="sd">      }</span>

<span class="sd">    По этим сопоставлениям мы считаем Semantic-Jaccard:</span>
<span class="sd">      jaccard_nodes  = intersection_nodes / union_nodes</span>
<span class="sd">      jaccard_edges  = intersection_edges / union_edges</span>

<span class="sd">    Результаты сохраняются в `output_path` (JSON), а также возвращаются:</span>
<span class="sd">      (результат_по_каждой_паре, средний_j_nodes, средний_j_edges).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_graphs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">generated_graphs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Длины списков графов не совпадают — сравнение невозможно.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">jaccard_nodes_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">jaccard_edges_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">orig_obj</span><span class="p">,</span> <span class="n">gen_obj</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">original_graphs</span><span class="p">,</span> <span class="n">generated_graphs</span><span class="p">)):</span>
        <span class="n">g1</span> <span class="o">=</span> <span class="n">orig_obj</span><span class="p">[</span><span class="s2">&quot;graph&quot;</span><span class="p">]</span>
        <span class="n">g2</span> <span class="o">=</span> <span class="n">gen_obj</span><span class="p">[</span><span class="s2">&quot;graph&quot;</span><span class="p">]</span>

        <span class="c1"># Сравниваем две структуры через LLM</span>
        <span class="n">comparison_res</span> <span class="o">=</span> <span class="n">_compare_two_graphs_llm</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comparison_res</span><span class="p">)</span>
        <span class="n">jaccard_nodes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comparison_res</span><span class="p">[</span><span class="s2">&quot;semantic_jaccard_nodes&quot;</span><span class="p">])</span>
        <span class="n">jaccard_edges_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comparison_res</span><span class="p">[</span><span class="s2">&quot;semantic_jaccard_edges&quot;</span><span class="p">])</span>

    <span class="c1"># Считаем средние значения</span>
    <span class="n">avg_nodes</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">sum</span><span class="p">(</span><span class="n">jaccard_nodes_list</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">jaccard_nodes_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">jaccard_nodes_list</span> <span class="k">else</span> <span class="mf">0.0</span>
    <span class="p">)</span>
    <span class="n">avg_edges</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">sum</span><span class="p">(</span><span class="n">jaccard_edges_list</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">jaccard_edges_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">jaccard_edges_list</span> <span class="k">else</span> <span class="mf">0.0</span>
    <span class="p">)</span>

    <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;avg_semantic_jaccard_nodes&quot;</span><span class="p">:</span> <span class="n">avg_nodes</span><span class="p">,</span>
        <span class="s2">&quot;avg_semantic_jaccard_edges&quot;</span><span class="p">:</span> <span class="n">avg_edges</span><span class="p">,</span>
        <span class="s2">&quot;pairs_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">final_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;per_pair&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span> <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">summary</span><span class="p">}</span>

    <span class="c1"># Сохраняем итоговый JSON</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">final_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Semantic-Jaccard similarity (avg over all pairs) ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nodes: </span><span class="si">{</span><span class="n">avg_nodes</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edges: </span><span class="si">{</span><span class="n">avg_edges</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Детальные результаты сохранены в </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">avg_nodes</span><span class="p">,</span> <span class="n">avg_edges</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_compare_two_graphs_llm</span><span class="p">(</span>
    <span class="n">g1</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">g2</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">pair_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;o1-mini&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Отправляет два диалоговых графа в LLM (o1-mini) и просит сопоставить их ноды и рёбра.</span>
<span class="sd">    Возвращает словарь с полями:</span>
<span class="sd">      {</span>
<span class="sd">        &quot;pair_index&quot;: &lt;int&gt;,</span>
<span class="sd">        &quot;semantic_jaccard_nodes&quot;: &lt;float&gt;,</span>
<span class="sd">        &quot;semantic_jaccard_edges&quot;: &lt;float&gt;,</span>
<span class="sd">        &quot;matched_nodes&quot;: [</span>
<span class="sd">          {</span>
<span class="sd">            &quot;node1_id&quot;: ...,</span>
<span class="sd">            &quot;node2_id&quot;: ...,</span>
<span class="sd">            &quot;node1_utterances&quot;: [...],</span>
<span class="sd">            &quot;node2_utterances&quot;: [...]</span>
<span class="sd">          },</span>
<span class="sd">          ...</span>
<span class="sd">        ],</span>
<span class="sd">        &quot;matched_edges&quot;: [</span>
<span class="sd">          {</span>
<span class="sd">            &quot;edge1&quot;: { &quot;source&quot;:..., &quot;target&quot;:..., &quot;utterances&quot;: [...] },</span>
<span class="sd">            &quot;edge2&quot;: { &quot;source&quot;:..., &quot;target&quot;:..., &quot;utterances&quot;: [...] }</span>
<span class="sd">          },</span>
<span class="sd">          ...</span>
<span class="sd">        ]</span>
<span class="sd">      }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Формируем сообщение для LLM.</span>
    <span class="c1"># Обратите внимание, что здесь мы предполагаем использование openai.ChatCompletion</span>
    <span class="c1"># Если для модели o1-mini нужен другой метод, адаптируйте.</span>

    <span class="c1"># &quot;-Match: &#39;I want a medium size.&#39; and &#39;I want pepperoni and mushrooms.&#39; if both texts are answers on question &#39;What size pizza would you like?&#39;\n&quot;</span>
    <span class="c1"># &quot;-No Match: &#39;I want a medium size.&#39; and &#39;I want pepperoni and mushrooms.&#39; if the first question &#39;What size pizza would you like?&#39;\n&quot;</span>
    <span class="n">system_message</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;You are an assistant that compares two dialog graphs.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;You must determine which nodes and edges from Graph1 match those in Graph2 by meaning (goal/dialog act/intent).</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Not all nodes or edges may have matched pairs. Only include the nodes and edges that have matching pairs.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;When analyzing, pay attention not only to the text of the nodes or edges in isolation, but also to their context:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;– for nodes, consider the incoming and outgoing edges;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;– for edges, consider the nodes they connect.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;For example, edges with the same text like “yes” may connect completely different nodes, which means they are not matching edges. The surrounding structure—adjacent nodes and edges—can provide more insight into the nature of the element being analyzed.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Identify only the similar edges and nodes between the two graphs.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Examples:</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;1. These nodes should be matched:</span>
<span class="sd">- &#39;I want to go to London.&#39; and &#39;My destination is New York.&#39; because they have the same meaning, express the same intent, and are responses to similar questions.</span>
<span class="sd">- &#39;Hello! How can I help you book a flight today?&#39; and &#39;Welcome! How can I assist you with your flight booking today?&#39; → because both utterances initiate the conversation, include a greeting, and ask the same question.</span>
<span class="sd">- &#39;Sure! Which city would you like to travel to?&#39; and &#39;What is your desired flight destination?&#39; → the same meaning of question</span>
<span class="sd">- &#39;I want to book a flight.&#39; and &#39;Help me with my flight booking.&#39; → Both utterances are responses to the question about how the assistant can help and express the same intent.</span>
<span class="sd">- &#39;Got it. Any specific toppings you’d prefer?&#39; and &#39;Please tell me your favorite toppings.&#39; → In both utterances, the assistant is clarifying the user’s topping preferences.</span>
<span class="sd">- &#39;Hi, want to discuss the current weather?&#39; and &#39;Let&#39;s talk about your weather preferences.&#39; → should be mathed if both utterances are starting nodes in the dialog graph and initiate a conversation about the weather.</span>
<span class="sd">- &#39;Stay cozy, and feel free to chat again soon!&#39; and &#39;It was great to learn about your weather likes!&#39; → should be mathed if both utterances are closing statements in the dialog and serve as a form of farewell.</span>
<span class="sd">- &#39;Hi! Want to chat about new tech gadgets?&#39;, &#39;Let&#39;s talk about the latest tech gadgets!&#39;, and &#39;What new gadgets have you heard about recently?&#39; → should be mathed if all of these utterances are starting points in the dialog graph and begin a conversation about gadgets.</span>
<span class="sd">- &#39;I’m curious about the latest smartwatch.&#39; and &#39;Tell me more about smartwatches.&#39; → because in these utterances the user is asking the assistant to talk about smartwatches in the context of a conversation about gadgets.</span>
<span class="sd">- &#39;Your flight is booked. Is there anything else I can help with?&#39; and &#39;Here is your booking confirmation.&#39; → In both utterances, the assistant informs the user that the flight has been booked. Although the first one includes an additional question, both serve as closing statements in the dialog graph.</span>

<span class="sd">2. These nodes should not be matched:</span>
<span class="sd">- &#39;I like music&#39; and &#39;My dog is very cute&#39; → These are different parts of the dialog graph, with different meanings and intents, not related to each other.</span>
<span class="sd">- &#39;Great. Could you let me know your preferred travel dates?&#39; and &#39;Thank you! I will confirm your booking shortly.&#39; → because the first is a question about travel dates, and the second is a statement about confirming the booking — their meanings are completely different.</span>
<span class="sd">- &#39;All right. I’ve found a suitable flight. Would you like to confirm the booking?&#39; and &#39;Your flight is booked! Have a great trip!&#39;</span>
<span class="sd">→ because the first asks for confirmation, while the second states that the booking has already been made and ends the conversation.</span>
<span class="sd">- &#39;My dates are the 10th to the 15th.&#39; and &#39;Yes, that works for me.&#39; → because the first responds to a question about travel dates, while the second is a generic positive response to a suggestion — different intents and meanings.</span>
<span class="sd">- &#39;All right. I’ve found a suitable flight. Would you like to confirm the booking?&#39; and &#39;Your flight has been booked successfully!&#39; → Even though both utterances concern the flight booking process, they reflect different intents and goals. In the first one, the assistant asks the user to confirm the booking, while in the second one, the assistant states that the booking has already been completed.</span>

<span class="sd">3.The decision depends on the context:</span>
<span class="sd">- &#39;It can track my sleep and stress levels.&#39; and &#39;Features like voice control are amazing!&#39; → should be matched if they are answers to the same semantic question and lead the conversation to a similar semantic node. If the utterances (which function as edges) direct the conversation to different semantic areas, then they are not considered similar. For example, if after &#39;It can track my sleep and stress levels.&#39; the conversation continues about stress tracking, and after &#39;Features like voice control are amazing!&#39; it continues about voice control features, then they should not be considered close.</span>
<span class="sd">- &#39;Yes, you can add cheese.&#39; and &#39;No, don’t add cheese.&#39; → These utterances are considered matched if they are responses to a standard question and lead to nodes that are also similar in meaning (e.g., a question about payment methods), and this is information only for slot filling mechanism. However, if these utterances lead to different dialog nodes (e.g., in the first case, the assistant asks about the type of cheese, and in the second case, the assistant asks about payment options), then they should not be considered related.</span>
<span class="sd">- &#39;Hi there! What&#39;s your favorite type of weather?&#39; and &#39;Do you like sunny days or cooler, cloudy weather?&#39; are more likely to be matched than the nodes &#39;Hi there! What&#39;s your favorite type of weather?&#39; and &#39;Hi, want to discuss the current weather?&#39;. In the second case, even though both utterances contain greetings, they lead to different intents — one asks about the user’s favorite type of weather, while the other asks for an opinion on the current weather. In contrast, in the first case, even though the first utterance includes a greeting and the second does not, they both ask essentially the same question about weather preferences. Furthermore, if the edges following the nodes in the first case are &#39;I prefer rainy weather.&#39; and &#39;Sunny days are my favorite.&#39; and they also lead to semantically close nodes, then those edges should be matched as well.</span>
<span class="sd">\n</span>
<span class="sd">&quot;&quot;&quot;</span>
        <span class="s2">&quot;Return ONLY valid JSON with the structure:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;{</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s1">&#39;  &quot;matched_nodes&quot;: [ [nodeId_in_graph1, nodeId_in_graph2], ... ],</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;  &quot;matched_edges&quot;: [ [src1, tgt1, src2, tgt2], ... ]</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s2">&quot;}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Do NOT include any extra keys or text outside this JSON.&quot;</span>
    <span class="p">)</span>

    <span class="n">user_prompt</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Graph1:</span><span class="se">\n</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span><span class="w"> </span><span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Graph2:</span><span class="se">\n</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">g2</span><span class="p">,</span><span class="w"> </span><span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Please identify semantically equivalent nodes and edges.&quot;</span>
    <span class="p">)</span>

    <span class="n">joint_prompt</span> <span class="o">=</span> <span class="n">system_message</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">user_prompt</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">joint_prompt</span><span class="p">}]</span>

    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Сравнение пары графов (pair_index=</span><span class="si">{</span><span class="n">pair_index</span><span class="si">}</span><span class="s2">) через LLM </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> ===&quot;</span>
    <span class="p">)</span>

    <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">]</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OPENAI_API_BASE&quot;</span><span class="p">]</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">llm_content</span> <span class="o">=</span> <span class="n">completion</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ошибка при обращении к модели: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Возвращаем формальный ответ, что сопоставления нет</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;pair_index&quot;</span><span class="p">:</span> <span class="n">pair_index</span><span class="p">,</span>
            <span class="s2">&quot;semantic_jaccard_nodes&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;semantic_jaccard_edges&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;matched_nodes&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;matched_edges&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

    <span class="c1"># Парсим ответ как JSON</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">llm_content</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">llm_content</span> <span class="o">=</span> <span class="n">llm_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">llm_content</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Не удалось распарсить JSON-ответ от модели.&quot;</span><span class="p">)</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;matched_nodes&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;matched_edges&quot;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="n">matched_nodes_pairs</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;matched_nodes&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">matched_edges_pairs</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;matched_edges&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="c1"># Сразу выведем какие узлы и рёбра модель «соединила»</span>
    <span class="n">matched_nodes_info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n1_id</span><span class="p">,</span> <span class="n">n2_id</span> <span class="ow">in</span> <span class="n">matched_nodes_pairs</span><span class="p">:</span>
        <span class="n">node1</span> <span class="o">=</span> <span class="n">_find_node_by_id</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span> <span class="n">n1_id</span><span class="p">)</span>
        <span class="n">node2</span> <span class="o">=</span> <span class="n">_find_node_by_id</span><span class="p">(</span><span class="n">g2</span><span class="p">,</span> <span class="n">n2_id</span><span class="p">)</span>
        <span class="n">matched_nodes_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;node1_id&quot;</span><span class="p">:</span> <span class="n">n1_id</span><span class="p">,</span>
                <span class="s2">&quot;node2_id&quot;</span><span class="p">:</span> <span class="n">n2_id</span><span class="p">,</span>
                <span class="s2">&quot;node1_utterances&quot;</span><span class="p">:</span> <span class="n">node1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;utterances&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">node1</span> <span class="k">else</span> <span class="p">[],</span>
                <span class="s2">&quot;node2_utterances&quot;</span><span class="p">:</span> <span class="n">node2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;utterances&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">node2</span> <span class="k">else</span> <span class="p">[],</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Модель сопоставила node </span><span class="si">{</span><span class="n">n1_id</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">node1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;utterances&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">node1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; с node </span><span class="si">{</span><span class="n">n2_id</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">node2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;utterances&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">node2</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="p">)</span>

    <span class="n">matched_edges_info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">src1</span><span class="p">,</span> <span class="n">tgt1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">tgt2</span> <span class="ow">in</span> <span class="n">matched_edges_pairs</span><span class="p">:</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="n">_find_edge</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span> <span class="n">src1</span><span class="p">,</span> <span class="n">tgt1</span><span class="p">)</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="n">_find_edge</span><span class="p">(</span><span class="n">g2</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">tgt2</span><span class="p">)</span>
        <span class="n">matched_edges_info</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;edge1&quot;</span><span class="p">:</span> <span class="n">e1</span><span class="p">,</span> <span class="s2">&quot;edge2&quot;</span><span class="p">:</span> <span class="n">e2</span><span class="p">})</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Модель сопоставила edge </span><span class="si">{</span><span class="n">src1</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">tgt1</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">e1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;utterances&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">e1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; с edge </span><span class="si">{</span><span class="n">src2</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">tgt2</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">e2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;utterances&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">e2</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Рассчитываем Jaccard для нод</span>
    <span class="n">total_nodes_g1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">g1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nodes&quot;</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="n">total_nodes_g2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">g2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nodes&quot;</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="n">intersection_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_nodes_pairs</span><span class="p">)</span>
    <span class="n">union_n</span> <span class="o">=</span> <span class="n">total_nodes_g1</span> <span class="o">+</span> <span class="n">total_nodes_g2</span> <span class="o">-</span> <span class="n">intersection_n</span>
    <span class="n">j_nodes</span> <span class="o">=</span> <span class="n">intersection_n</span> <span class="o">/</span> <span class="n">union_n</span> <span class="k">if</span> <span class="n">union_n</span> <span class="k">else</span> <span class="mf">0.0</span>

    <span class="c1"># Рассчитываем Jaccard для рёбер</span>
    <span class="n">total_edges_g1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">g1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;edges&quot;</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="n">total_edges_g2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">g2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;edges&quot;</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="n">intersection_e</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_edges_pairs</span><span class="p">)</span>
    <span class="n">union_e</span> <span class="o">=</span> <span class="n">total_edges_g1</span> <span class="o">+</span> <span class="n">total_edges_g2</span> <span class="o">-</span> <span class="n">intersection_e</span>
    <span class="n">j_edges</span> <span class="o">=</span> <span class="n">intersection_e</span> <span class="o">/</span> <span class="n">union_e</span> <span class="k">if</span> <span class="n">union_e</span> <span class="k">else</span> <span class="mf">0.0</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;pair_index&quot;</span><span class="p">:</span> <span class="n">pair_index</span><span class="p">,</span>
        <span class="s2">&quot;semantic_jaccard_nodes&quot;</span><span class="p">:</span> <span class="n">j_nodes</span><span class="p">,</span>
        <span class="s2">&quot;semantic_jaccard_edges&quot;</span><span class="p">:</span> <span class="n">j_edges</span><span class="p">,</span>
        <span class="s2">&quot;matched_nodes&quot;</span><span class="p">:</span> <span class="n">matched_nodes_info</span><span class="p">,</span>
        <span class="s2">&quot;matched_edges&quot;</span><span class="p">:</span> <span class="n">matched_edges_info</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_find_node_by_id</span><span class="p">(</span><span class="n">graph</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">node_id</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Возвращает ноду с указанным &#39;id&#39; из graph[&#39;nodes&#39;] или None.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nodes&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">node_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">n</span>
    <span class="k">return</span> <span class="p">{}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_find_edge</span><span class="p">(</span><span class="n">graph</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">src</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">tgt</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Возвращает ребро из graph[&#39;edges&#39;] с указанными source и target или None.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;edges&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">src</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">tgt</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span>
    <span class="k">return</span> <span class="p">{}</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2025, Denis Kuznetsov, Anastasia Voznyuk, Andrey Chirkin, Anna Mikhailova, Maria Molchanova, Yuri Peshkichev.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>